#define JPEG_INTERNALS
#define INPUT_VARS(cinfo)  \
#define INPUT_SYNC(cinfo)  \
#define INPUT_RELOAD(cinfo)  \
#define MAKE_BYTE_AVAIL(cinfo,action)  \
#define INPUT_BYTE(cinfo,V,action)  \
#define INPUT_2BYTES(cinfo,V,action)  \
#define get_dac(cinfo)  skip_variable(cinfo)
#define APP0_DATA_LEN	14	/* Length of interesting data in APP0 */
#define APP14_DATA_LEN	12	/* Length of interesting data in APP14 */
#define APPN_DATA_LEN	14	/* Must be the largest of the above!! */

LOCAL(boolean)
get_sos (j_decompress_ptr cinfo)
/* Process a SOS marker */
{
  INT32 length;
  int i, ci, n, c, cc;
  jpeg_component_info * compptr;
  INPUT_VARS(cinfo);

  if (! cinfo->marker->saw_SOF)
    ERREXIT(cinfo, JERR_SOS_NO_SOF);

  INPUT_2BYTES(cinfo, length, return FALSE);

  INPUT_BYTE(cinfo, n, return FALSE); /* Number of components */

  TRACEMS1(cinfo, 1, JTRC_SOS, n);

  if (length != (n * 2 + 6) || n < 1 || n > MAX_COMPS_IN_SCAN)
    ERREXIT(cinfo, JERR_BAD_LENGTH);

  cinfo->comps_in_scan = n;

  /* Collect the component-spec parameters */

  /* BUG: stack buffer overflow
   *   for (i = 0; i < cinfo->num_components; i++)
   *     cinfo->cur_comp_info[i] = NULL;
   * 
   *   for (i = 0; i < n; i++) {
   *     INPUT_BYTE(cinfo, cc, return FALSE);
   *     INPUT_BYTE(cinfo, c, return FALSE);
   *     
   *     for (ci = 0, compptr = cinfo->comp_info; ci < cinfo->num_components;
   * 	 ci++, compptr++) {
   *       if (cc == compptr->component_id && !cinfo->cur_comp_info[ci])
   * FIXED:
   */
